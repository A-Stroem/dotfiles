#!/usr/bin/env bash
# ============================================================
# Core package installation (macOS + WSL Ubuntu)
# ============================================================

set -euo pipefail

NOTES_FILE="${XDG_STATE_HOME:-$HOME/.local/state}/dotfiles/install-final-notes.txt"
mkdir -p "$(dirname "$NOTES_FILE")"
add_note() {
  printf '%s\n' "$1" >> "$NOTES_FILE"
}

# Helper functions
is_darwin() { [[ "$(uname -s)" == "Darwin" ]]; }
is_linux() { [[ "$(uname -s)" == "Linux" ]]; }
is_wsl() { grep -qi microsoft /proc/version 2>/dev/null; }

# Map uname -m to common binary naming conventions
get_arch() {
  local arch
  arch="$(uname -m)"
  case "$arch" in
    x86_64)  echo "amd64" ;;
    aarch64) echo "arm64" ;;
    armv7l)  echo "armv7" ;;
    *)       echo "$arch" ;;
  esac
}

# Fetch the latest release tag from a GitHub repo
# Usage: github_latest_tag owner/repo
github_latest_tag() {
  curl -fsSL "https://api.github.com/repos/$1/releases/latest" | jq -r '.tag_name'
}

# Some systems have legacy SSH remotes for Homebrew taps.
# Normalize them to HTTPS so brew update does not depend on SSH key setup.
normalize_homebrew_remotes() {
  local repos repo remote_path current_remote
  repos=()

  repos+=("$(brew --repo)")
  while IFS= read -r repo; do
    repos+=("$(brew --repo "$repo" 2>/dev/null || true)")
  done < <(brew tap)

  for repo in "${repos[@]}"; do
    [[ -z "$repo" || ! -d "$repo/.git" ]] && continue
    current_remote="$(git -C "$repo" remote get-url origin 2>/dev/null || true)"
    if [[ "$current_remote" =~ ^git@github\.com:(.+)$ ]]; then
      remote_path="${BASH_REMATCH[1]}"
      git -C "$repo" remote set-url origin "https://github.com/${remote_path}" || true
    fi
  done
}

# Install Docker Engine + Compose plugin on apt-based Linux.
# Uses Docker's official repository when possible and falls back to distro packages.
install_docker_linux() {
  if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
    echo "‚úÖ Docker and Docker Compose already installed"
    return 0
  fi

  echo "üì¶ Installing Docker Engine + Docker Compose..."

  # shellcheck disable=SC1091
  . /etc/os-release
  local distro="${ID:-ubuntu}"
  local codename="${VERSION_CODENAME:-}"
  local repo_file="/etc/apt/sources.list.d/docker.list"

  if [[ -z "$codename" ]] && command -v lsb_release >/dev/null 2>&1; then
    codename="$(lsb_release -cs)"
  fi

  if [[ "$distro" == "ubuntu" || "$distro" == "debian" ]] && [[ -n "$codename" ]]; then
    sudo install -m 0755 -d /etc/apt/keyrings
    if [[ ! -f /etc/apt/keyrings/docker.asc ]]; then
      curl -fsSL "https://download.docker.com/linux/${distro}/gpg" | sudo tee /etc/apt/keyrings/docker.asc >/dev/null
      sudo chmod a+r /etc/apt/keyrings/docker.asc
    fi

    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/${distro} ${codename} stable" | \
      sudo tee "$repo_file" >/dev/null

    sudo apt update
    sudo apt install -y \
      docker-ce \
      docker-ce-cli \
      containerd.io \
      docker-buildx-plugin \
      docker-compose-plugin
  else
    echo "‚ö†Ô∏è  Unsupported distro metadata for Docker repo (ID=${distro}, CODENAME=${codename})."
    echo "   Falling back to distro Docker packages."
    sudo apt install -y docker.io docker-compose-v2 docker-compose-plugin || \
      sudo apt install -y docker.io docker-compose-plugin
  fi

  # Let the current user run docker without sudo after next login/newgrp.
  sudo groupadd docker 2>/dev/null || true
  sudo usermod -aG docker "$USER" || true
}

echo "üöÄ Installing core packages..."

# ----------------------------
# macOS installation
# ----------------------------
if is_darwin; then
  echo "üì¶ Detected macOS - using Homebrew"
  
  # Install Homebrew if missing
  if ! command -v brew >/dev/null 2>&1; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH for Apple Silicon
    if [[ "$(uname -m)" == "arm64" ]]; then
      eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
  fi
  
  # Update Homebrew
  normalize_homebrew_remotes
  brew update
  
  # Install core packages
  brew install \
    git \
    zsh \
    starship \
    mise \
    zoxide \
    fzf \
    ripgrep \
    fd \
    bat \
    eza \
    jq \
    yq \
    direnv \
    tmux \
    uv \
    pipx \
    curl \
    wget \
    tree \
    htop
  
  # Install fzf keybindings (non-interactive)
  if [[ -x "$(brew --prefix)/opt/fzf/install" ]]; then
    "$(brew --prefix)/opt/fzf/install" --key-bindings --completion --no-update-rc || true
  fi

  # Install zsh plugins
  echo "üì¶ Installing zsh plugins..."
  brew install zsh-syntax-highlighting zsh-autosuggestions

  # Kubernetes tools
  echo "üì¶ Installing Kubernetes tools..."
  brew install \
    kubectl \
    kubectx \
    helm \
    k9s
  
  echo "‚úÖ macOS core packages installed"

# ----------------------------
# Linux (Ubuntu/Debian) installation
# ----------------------------
elif is_linux; then
  echo "üì¶ Detected Linux - using apt"
  
  # Update package list
  sudo apt update
  
  # Install core packages available via apt
  sudo apt install -y \
    git \
    zsh \
    fzf \
    ripgrep \
    fd-find \
    jq \
    direnv \
    tmux \
    pipx \
    curl \
    wget \
    ca-certificates \
    gnupg \
    lsb-release \
    tree \
    htop \
    unzip \
    vim
  
  # Install Starship (not in Ubuntu repos)
  if ! command -v starship >/dev/null 2>&1; then
    echo "üì¶ Installing Starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -y
  fi
  
  # Install mise (not in Ubuntu repos)
  if ! command -v mise >/dev/null 2>&1; then
    echo "üì¶ Installing mise..."
    curl https://mise.run | sh
    # Add to PATH for this session
    export PATH="$HOME/.local/bin:$PATH"
  fi
  
  # Install uv (not in Ubuntu repos)
  if ! command -v uv >/dev/null 2>&1; then
    echo "üì¶ Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
  fi
  
  # Install zsh plugins
  echo "üì¶ Installing zsh plugins..."
  sudo apt install -y zsh-syntax-highlighting zsh-autosuggestions 2>/dev/null || {
    echo "‚ö†Ô∏è  zsh plugins not in apt, cloning from git..."
    ZSH_PLUGINS_DIR="$HOME/.zsh/plugins"
    mkdir -p "$ZSH_PLUGINS_DIR"
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_PLUGINS_DIR/zsh-syntax-highlighting" 2>/dev/null || \
      (cd "$ZSH_PLUGINS_DIR/zsh-syntax-highlighting" && git pull)
    git clone https://github.com/zsh-users/zsh-autosuggestions.git "$ZSH_PLUGINS_DIR/zsh-autosuggestions" 2>/dev/null || \
      (cd "$ZSH_PLUGINS_DIR/zsh-autosuggestions" && git pull)
  }

  # Install modern tools if available (Ubuntu 22.04+)
  echo "üì¶ Installing modern CLI tools (if available)..."
  sudo apt install -y zoxide bat eza 2>/dev/null || {
    echo "‚ö†Ô∏è  Some modern tools not available via apt (zoxide, bat, eza)"
    echo "   These will work on Ubuntu 24.04+ or install manually"
  }

  # Create bat symlink if batcat is installed (Ubuntu names it batcat)
  if command -v batcat >/dev/null 2>&1 && ! command -v bat >/dev/null 2>&1; then
    echo "üì¶ Creating bat symlink for batcat..."
    mkdir -p "$HOME/.local/bin"
    ln -sf "$(command -v batcat)" "$HOME/.local/bin/bat"
  fi
  
  # Install kubectl (architecture-aware)
  if ! command -v kubectl >/dev/null 2>&1; then
    echo "üì¶ Installing kubectl..."
    kube_arch="$(get_arch)"
    kube_stable="$(curl -L -s https://dl.k8s.io/release/stable.txt)"
    curl -LO "https://dl.k8s.io/release/${kube_stable}/bin/linux/${kube_arch}/kubectl"
    # Verify checksum
    curl -LO "https://dl.k8s.io/release/${kube_stable}/bin/linux/${kube_arch}/kubectl.sha256"
    if echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check --status 2>/dev/null; then
      echo "‚úÖ kubectl checksum verified"
    else
      echo "‚ö†Ô∏è  kubectl checksum verification failed, installing anyway"
    fi
    sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
    rm -f kubectl kubectl.sha256
  fi
  
  # Install kubectx/kubens
  if ! command -v kubectx >/dev/null 2>&1; then
    echo "üì¶ Installing kubectx/kubens..."
    sudo git clone https://github.com/ahmetb/kubectx /opt/kubectx 2>/dev/null || \
      (cd /opt/kubectx && sudo git pull)
    sudo ln -sf /opt/kubectx/kubectx /usr/local/bin/kubectx
    sudo ln -sf /opt/kubectx/kubens /usr/local/bin/kubens
  fi
  
  # Install helm
  if ! command -v helm >/dev/null 2>&1; then
    echo "üì¶ Installing helm..."
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  fi
  
  # Install k9s (latest release, architecture-aware)
  if ! command -v k9s >/dev/null 2>&1; then
    echo "üì¶ Installing k9s..."
    k9s_arch="$(get_arch)"
    k9s_version="$(github_latest_tag derailed/k9s)"
    wget -qO- "https://github.com/derailed/k9s/releases/download/${k9s_version}/k9s_Linux_${k9s_arch}.tar.gz" | tar xvz -C /tmp
    sudo mv /tmp/k9s /usr/local/bin/
  fi

  # Install Docker runtime + Compose (needed by docker aliases in zshrc)
  install_docker_linux
  
  echo "‚úÖ Linux core packages installed"

else
  echo "‚ùå Unsupported OS: $(uname -s)"
  exit 1
fi

# ----------------------------
# Common post-install (both platforms)
# ----------------------------

# Ensure pipx path is available
if command -v pipx >/dev/null 2>&1; then
  pipx ensurepath || true
fi

# Install Ansible + ansible-lint via pipx (isolated from system Python)
if command -v pipx >/dev/null 2>&1; then
  echo "üì¶ Installing Ansible via pipx..."
  pipx install --include-deps ansible || pipx upgrade ansible
  pipx install ansible-lint || pipx upgrade ansible-lint
fi

# Create SSH sockets directory for connection multiplexing
mkdir -p "$HOME/.ssh/sockets"

# Set zsh as default shell if not already
if command -v zsh >/dev/null 2>&1; then
  if [[ "${SHELL:-}" != "$(command -v zsh)" ]]; then
    echo "üêö Setting zsh as default shell..."
    if is_darwin; then
      chsh -s "$(command -v zsh)" || true
    else
      # On Linux, may need sudo
      sudo chsh -s "$(command -v zsh)" "$USER" || true
    fi
  fi
fi

echo ""
echo "‚úÖ Core installation complete!"

add_note "Restart your shell: exec zsh"
add_note "Set up GPG key: gpg --full-generate-key"
add_note "Configure git signing key: git config --global user.signingkey YOUR_KEY_ID"
if is_wsl; then
  add_note "Docker on WSL: run 'newgrp docker' (or restart WSL) to use docker without sudo"
fi
