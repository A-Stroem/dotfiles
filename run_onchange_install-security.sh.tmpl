#!/usr/bin/env bash
# ============================================================
# Security tools installation (gitleaks, trivy, checkov)
# ============================================================

set -euo pipefail

NOTES_FILE="${XDG_STATE_HOME:-$HOME/.local/state}/dotfiles/install-final-notes.txt"
mkdir -p "$(dirname "$NOTES_FILE")"
add_note() {
  printf '%s\n' "$1" >> "$NOTES_FILE"
}

echo "ðŸ”’ Installing security scanning tools..."

# Helper functions
is_darwin() { [[ "$(uname -s)" == "Darwin" ]]; }
is_linux() { [[ "$(uname -s)" == "Linux" ]]; }

get_arch() {
  local arch
  arch="$(uname -m)"
  case "$arch" in
    x86_64)  echo "x64" ;;
    aarch64) echo "arm64" ;;
    armv7l)  echo "armv7" ;;
    *)       echo "$arch" ;;
  esac
}

github_latest_tag() {
  curl -fsSL "https://api.github.com/repos/$1/releases/latest" | jq -r '.tag_name'
}

# ----------------------------
# Install gitleaks (secret scanning)
# ----------------------------
if ! command -v gitleaks >/dev/null 2>&1; then
  echo "ðŸ“¦ Installing gitleaks..."
  
  if is_darwin; then
    brew install gitleaks
  elif is_linux; then
    gl_arch="$(get_arch)"
    gl_tag="$(github_latest_tag gitleaks/gitleaks)"
    gl_version="${gl_tag#v}"
    wget -qO- "https://github.com/gitleaks/gitleaks/releases/download/${gl_tag}/gitleaks_${gl_version}_linux_${gl_arch}.tar.gz" \
      | tar xvz -C /tmp
    sudo mv /tmp/gitleaks /usr/local/bin/
    sudo chmod +x /usr/local/bin/gitleaks
  fi
  
  echo "âœ… gitleaks installed"
else
  echo "âœ… gitleaks already installed"
fi

# ----------------------------
# Install trivy (vulnerability/IaC scanning)
# ----------------------------
if ! command -v trivy >/dev/null 2>&1; then
  echo "ðŸ“¦ Installing trivy..."
  
  if is_darwin; then
    brew install trivy
  elif is_linux; then
    # Install from official repository
    sudo apt-get install -y wget apt-transport-https gnupg lsb-release
    wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
    echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
    sudo apt-get update
    sudo apt-get install -y trivy
  fi
  
  echo "âœ… trivy installed"
else
  echo "âœ… trivy already installed"
fi

# ----------------------------
# Install checkov (IaC security scanning)
# ----------------------------
if ! command -v checkov >/dev/null 2>&1; then
  echo "ðŸ“¦ Installing checkov..."
  
  if command -v pipx >/dev/null 2>&1; then
    pipx install checkov
  elif command -v pip3 >/dev/null 2>&1; then
    pip3 install --user checkov
  else
    echo "âš ï¸  pipx/pip3 not found, skipping checkov installation"
  fi
  
  echo "âœ… checkov installed"
else
  echo "âœ… checkov already installed"
fi

# ----------------------------
# Install pre-commit framework
# ----------------------------
if ! command -v pre-commit >/dev/null 2>&1; then
  echo "ðŸ“¦ Installing pre-commit..."
  
  if command -v pipx >/dev/null 2>&1; then
    pipx install pre-commit
  elif command -v pip3 >/dev/null 2>&1; then
    pip3 install --user pre-commit
  else
    echo "âš ï¸  pipx/pip3 not found, skipping pre-commit installation"
  fi
  
  echo "âœ… pre-commit installed"
else
  echo "âœ… pre-commit already installed"
fi

# ----------------------------
# Install git-secrets (prevent committing secrets)
# ----------------------------
if ! command -v git-secrets >/dev/null 2>&1; then
  echo "ðŸ“¦ Installing git-secrets..."
  
  if is_darwin; then
    brew install git-secrets
  elif is_linux; then
    # Install build dependencies if not present
    if ! command -v make >/dev/null 2>&1; then
      echo "ðŸ“¦ Installing build tools..."
      sudo apt-get install -y build-essential
    fi
    
    # Clone and install
    if [ ! -d "/tmp/git-secrets" ]; then
      git clone https://github.com/awslabs/git-secrets.git /tmp/git-secrets
    fi
    cd /tmp/git-secrets
    sudo make install
    cd -
    rm -rf /tmp/git-secrets
  fi
  
  echo "âœ… git-secrets installed"
else
  echo "âœ… git-secrets already installed"
fi

# ----------------------------
# Create gitleaks config
# ----------------------------
mkdir -p "$HOME/.config/gitleaks"
if [ ! -f "$HOME/.config/gitleaks/gitleaks.toml" ]; then
  cat > "$HOME/.config/gitleaks/gitleaks.toml" << 'EOF'
title = "Gitleaks config for MSSP work"

[extend]
useDefault = true

[[rules]]
id = "customer-api-keys"
description = "Customer API keys"
regex = '''(?i)(api[_-]?key|apikey|api[_-]?secret|customer[_-]?token)['"]?\s*[:=]\s*['"]?[a-zA-Z0-9]{20,}'''

[[rules]]
id = "ansible-vault-password"
description = "Ansible vault passwords"
regex = '''(?i)(vault[_-]?pass|vault[_-]?password|ansible[_-]?vault)['"]?\s*[:=]\s*['"]?[a-zA-Z0-9]{10,}'''

[[rules]]
id = "1password-references"
description = "1Password secret references (should use op read)"
regex = '''op://[A-Za-z0-9-]+/[A-Za-z0-9-]+/[A-Za-z0-9-]+'''
[rules.allowlist]
description = "Allow in direnvrc and documentation"
paths = [
  '''\.direnvrc$''',
  '''direnvrc$''',
  '''README\.md$''',
  '''\.md$'''
]

[[rules]]
id = "aws-access-key"
description = "AWS Access Key"
regex = '''(A3T[A-Z0-9]|AKIA|AGPA|AIDA|AROA|AIPA|ANPA|ANVA|ASIA)[A-Z0-9]{16}'''

[[rules]]
id = "private-key"
description = "Private Key"
regex = '''-----BEGIN (RSA |OPENSSH |EC )?PRIVATE KEY-----'''
EOF
  echo "âœ… Created gitleaks configuration"
fi

echo ""
echo "ðŸ“ Security tools installed successfully!"

add_note "Enable git hooks per repo: pre-commit install"
add_note "Security quick test: gitleaks detect --no-git"
add_note "Security quick test: trivy fs ."
add_note "Security quick test: checkov -d ."
