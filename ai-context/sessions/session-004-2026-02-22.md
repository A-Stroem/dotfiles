# Session 004 - 2026-02-22

**Date:** February 22, 2026
**Context:** Multi-repo — `web/color-grading-pm` (frontend), `colorgrading/ansible` + `colorgrading/workflows` (Ansible), `colorgrading/tools` (secrets), `colorgrading/` (architecture planning)

## Summary

Fixed two runtime bugs (Alpine.js `clientEditMode` ReferenceError and Ansible recursive template loop), applied pending code fixes (env-first secrets order, Frame.io project name mismatch), updated CLAUDE.md files with session learnings, implemented the uv workspace, then designed and fully reviewed a comprehensive distribution-ready architecture plan for the colorgrading suite (Phases 0–7 + Pre-Phase 1). Closed the planning phase by applying all 22 critical review findings.

## Tasks Completed

- **Fix: `clientEditMode` Alpine.js ReferenceError** — Added `clientEditMode: false` to x-data object in `color-grading-pm/frontend/app.js`; reset in `openClientDetail()` and `closeClientDetail()`.
- **Fix: Ansible recursive loop `invoice_description`** — Removed self-referential `{{ invoice_description | default('') }}` from `deliver_project.yml` role vars block; `defaults/main.yml` provides the default.
- **Fix: `secrets.py` env-first order** — Reversed lookup to check env var before `op` CLI, preventing interactive auth prompts in Ansible subprocess contexts.
- **Fix: Frame.io project name mismatch** — Added `frameio_project_name` extra var to `cg_flow.py`, propagated through `deliver_project.yml` and `project_delivery` role to use the Resolve key (not the normalized PM name).
- **CLAUDE.md updates** — Created `colorgrading/workflows/CLAUDE.md` (new), updated `web/color-grading-pm/CLAUDE.md` (Alpine.js gotchas), updated `colorgrading/tools/CLAUDE.md` (env-first secrets note).
- **Phase 0: uv workspace** — Created `colorgrading/pyproject.toml` workspace root; updated all four repos' pyproject.toml files and ansible.cfg to use the shared `.venv/`.
- **Architecture Plan** — Created `colorgrading/ARCHITECTURE-PLAN.md` (~1100 lines): Vision, Add-On Model, Three Layers, Current→Target structure, Phases 0–7, Pre-Phase 1 immediate actions, Secure Development Principles, Software Design Principles (SOLID/DRY/KISS/YAGNI).
- **Critical review** — Dispatched `superpowers:code-reviewer` subagent, found 22 issues (6 Critical, 9 Important, 7 Minor). Applied all 22 fixes across two sessions.
- **Created `colorgrading/CLAUDE.md`** — Workspace-level dev guide (SOLID checklist, add-on model rule, code boundaries, security rules, common mistakes). Updated with additional gotchas from review.

## Files Modified

**`web/color-grading-pm/frontend/app.js`**
- Added `clientEditMode: false` to Alpine.js data object
- Reset `this.clientEditMode = false` in open/close client handlers

**`colorgrading/workflows/playbooks/deliver_project.yml`**
- Removed self-referential `invoice_description` role var
- Added `frameio_project_name` role var

**`colorgrading/ansible/roles/project_delivery/tasks/main.yml`**
- Frame.io upload task: use `frameio_project_name | default(project_name)`

**`colorgrading/ansible/roles/project_delivery/defaults/main.yml`**
- Added `frameio_project_name: ""`

**`colorgrading/tools/colorgrading/secrets.py`**
- Env var checked first, `op` CLI second

**`colorgrading/workflows/scripts/cg_flow.py`**
- Added `frameio_project_name: resolve_key` to `cmd_deliver` extra_vars

**`colorgrading/pyproject.toml`** (new)
- uv workspace root with all four repos as members

**`colorgrading/workflows/pyproject.toml`**, **`colorgrading/ansible/pyproject.toml`**, **`colorgrading/workflows/ansible.cfg`**
- Updated to use workspace venv and workspace-relative sources

**`colorgrading/ARCHITECTURE-PLAN.md`** (new, ~1100 lines)
- Full distribution-ready architecture plan with all 22 review findings applied

**`colorgrading/CLAUDE.md`** (new)
- Workspace-level guidance with SOLID, add-on model, security, and common mistake rules

**`colorgrading/workflows/CLAUDE.md`** (new)
- Ansible gotchas: recursive vars, interpreter_python, op sessions, uv

**`web/color-grading-pm/CLAUDE.md`**, **`colorgrading/tools/CLAUDE.md`**
- Added session learnings

## Key Decisions

- **Keep four separate git repos** — uv workspace at `colorgrading/` root handles shared dev environment; AWX compatibility preserved for ansible/workflows.
- **Option D architecture** — Distribution-ready with adapter/interface pattern; three layers (Layer 1: resolve-api, Layer 2: tools, Layer 3: personal ansible/workflows).
- **PMInterface contract is `client_name: str`** — CGPMAdapter does the name→id lookup internally; orchestrator never handles raw PM IDs.
- **`resolve_sdk` must NOT import from `colorgrading.core`** — Would invert Layer 1→2 dependency. Keep both secrets managers parallel until a safe consolidation is possible.
- **`NullAdapter` list methods return `[]`, never `None`** — Callers iterate directly.
- **Bootstrap uses `importlib.resources`** — `__file__.parent.parent` breaks for non-editable installs.
- **`resolve_sdk/config.json` cleanup in Phase 2**, not deferred to Phase 6 — same hardcoded-paths problem as other Phase 2 items.
- **Python version floor: `>=3.10`** — Python 3.9 reaches EOL October 2025; standardised across all four repos.

## Architecture Plan Summary (Phases)

| Phase | Status | Summary |
|-------|--------|---------|
| Pre-Phase 1 | Pending | Remove `frameio_tokens.json` from git history, fix Python version, remove legacy venvs, set up CI/CD |
| 0 | ✅ Done | uv workspace |
| 1 | Pending | Reorganise into `core/` + `integrations/` (no behaviour changes) |
| 2 | Pending | `cg-setup`, `cg-doctor`, `config.example.yaml`, remove all hardcoded personal values |
| 3 | Pending | Abstract interfaces: PMInterface, InvoiceInterface, SecretsInterface + NullAdapters |
| 4 | Pending | Adapter-driven ProjectOrchestrator + Ansible module updates |
| 5 | Pending | Cross-platform bootstrap (macOS + Windows) |
| 6 | Pending | Docs, cleanup, distribution prep, Windows fcntl fix |
| 7 | Pending | PyPI / git distribution (decision point) |

## Issues Encountered

- **Alpine.js ReferenceError** — variables used in templates must be declared in `x-data`. Now documented in CLAUDE.md.
- **Ansible recursive template loop** — self-referential `{{ varname | default('') }}` in role vars. Now documented in CLAUDE.md.
- **Multiple venvs** — `tools/venv/` and `resolve-api/venv/` pre-existing alongside the new workspace venv caused confusion. Resolved by workspace unifying everything.

## Next Steps

- [ ] Pre-Phase 1: Remove `frameio_tokens.json` from git history (`git filter-repo`)
- [ ] Pre-Phase 1: Standardise all `pyproject.toml` to `requires-python = ">=3.10"`
- [ ] Pre-Phase 1: Remove legacy `tools/venv/` and `resolve-api/venv/` directories
- [ ] Pre-Phase 1: Add `.github/workflows/ci.yml` to all four repos
- [ ] Phase 1: Create `core/` + `integrations/` directory structure in `tools/`
- [ ] Verify `workflows/scripts/cg_flow.py` deliver fix end-to-end

## Tags

`#bugfix` `#architecture` `#planning` `#uv-workspace` `#ansible` `#security` `#refactoring`
