# Session 003 - 2026-02-21

**Date:** February 21, 2026
**Context:** Multi-repo — `web/finance-tracker` (backend) and `colorgrading/resolve-api` (Deliver scripts)

## Summary

Debugged and resolved a chain of 502 Bad Gateway errors on the finance-tracker backend running in Docker on the Pi. Three sequential container crashes were fixed (log directory permissions, `@/` path alias resolution, uploads directory permissions), plus a Prisma migration provider mismatch that prevented database migrations from running. The app is now functional. Additionally, enhanced the resolve-api render handoff script to auto-suggest the render output directory from the project name and to skip the render script's own location prompt when called from the handoff flow.

## Tasks Completed

- **Fix 1: EACCES `/app/logs`** — Winston `transports.File` calls `mkdirSync('logs')` at module load before the server binds. `appuser` had no write access to `/app`. Fixed by pre-creating `/app/logs` with correct ownership in the Dockerfile before `USER appuser`.
- **Fix 2: `Cannot find module '@/config/logger'`** — `tsc` compiles TypeScript but does not rewrite `@/` path aliases in output JS. 8 source files used `@/` imports, all failing at runtime. Installed `tsc-alias`, changed build script to `tsc && tsc-alias`.
- **Fix 3: EACCES `/app/uploads`** — Same pattern as logs/: `document.routes.ts` calls `mkdirSync(uploadsDir)` at module load. Fixed by adding `/app/uploads` to the same `mkdir -p && chown` line in the Dockerfile.
- **Fix 4: Prisma migration provider mismatch** — `migration_lock.toml` declared `sqlite` but `schema.prisma` used `postgresql`. All 9 old SQLite migrations deleted, single comprehensive PostgreSQL initial migration created, lock file updated.
- **Fix 5: Entrypoint** — Removed conditional `RUN_DB_PUSH_ON_START` guard; entrypoint now unconditionally runs `prisma migrate deploy` on container start.
- **Fix 6: Console transport missing in production** — Winston was configured to add console transport only when `NODE_ENV !== "production"`, making `docker logs` completely blind. Fixed to always include Console transport.
- **resolve-api: auto-suggest render output path** — Added `_get_smart_render_dir()` and `_find_newest_render_since()` to handoff script. When the smart directory is found, the user is prompted to confirm it; after render the newest file is auto-detected and presented as the default delivery path.
- **resolve-api: skip render script location prompt** — Added `CG_RENDER_OUTPUT_DIR` env var bypass to both location-selection blocks in `render_current_timeline.py`. Handoff script sets this env var before calling `render_main()` so the render script skips its own interactive location prompts.

## Files Modified

**`web/finance-tracker/backend/`**
- `Dockerfile` — Pre-create `/app/logs` and `/app/uploads` with correct ownership; remove `RUN_DB_PUSH_ON_START` env default
- `src/config/logger.ts` — Always include Console transport (removed `process.env.NODE_ENV !== "production"` guard)
- `package.json` — Added `tsc-alias` to devDependencies; build script changed to `tsc && tsc-alias`
- `scripts/docker-entrypoint.sh` — Unconditionally run `prisma migrate deploy` on startup
- `prisma/migrations/migration_lock.toml` — Changed provider from `sqlite` to `postgresql`
- `prisma/migrations/20260221000000_init_postgresql/migration.sql` — New: single comprehensive PostgreSQL initial migration (all 9 old SQLite migrations deleted)

**`colorgrading/resolve-api/scripts/Deliver/`**
- `render_current_timeline_handoff.py` — Added `_get_smart_render_dir()`, `_find_newest_render_since()`, updated `_prompt()` with default parameter, restructured `main()` for auto-path detection; sets `CG_RENDER_OUTPUT_DIR` before calling `render_main()`
- `render_current_timeline.py` — Added `CG_RENDER_OUTPUT_DIR` env var bypass to both location-selection blocks (lines ~1035 and ~1258)

## Key Decisions

- **Single init migration vs incremental migrations**: Rather than converting 9 SQLite migrations to PostgreSQL, wrote a single comprehensive initial migration covering the full current schema. Appropriate since there was no production data to preserve.
- **Always-on console transport**: In production Docker, file logs are secondary to `docker logs`. Console transport should always be active regardless of `NODE_ENV`.
- **`tsc-alias` over `tsconfig-paths/register`**: `tsconfig-paths/register` only works with `ts-node` (dev). For production compiled Node.js, `tsc-alias` is the correct post-processing step.
- **`CG_RENDER_OUTPUT_DIR` env var pattern**: Follows existing `CG_DISABLE_FRAMEIO_UPLOAD` pattern — env vars as bypass flags for automation/scripted invocation, keeping scripts fully interactive when called standalone.

## Issues Encountered

- **Three sequential container crashes** — Each crash was only visible after fixing the previous one (permissions → alias resolution → permissions again). Required separate rebuild/deploy cycles to surface each layer.
- **SQLite vs PostgreSQL SQL incompatibility** — Old migrations used `PRAGMA`, `DATETIME`, and `TEXT NOT NULL PRIMARY KEY` which are invalid in PostgreSQL. Resolved by starting fresh with a PostgreSQL-native migration.

## Next Steps

- [ ] Verify finance-tracker frontend is built out / connected to the backend
- [ ] Test resolve-api handoff script end-to-end with a real render job

## Tags

`#bugfix` `#deployment` `#database` `#docker` `#feature` `#tooling`
